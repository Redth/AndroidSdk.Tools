name: Run Android Emulator

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  run:
    name: Run (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            gpu: swiftshader_indirect
            image: system-images;android-36;google_apis;x86_64
            abi: google_apis/x86_64
          - os: macos-latest
            gpu: guest
            image: system-images;android-36;google_apis;arm64-v8a
            abi: google_apis/arm64-v8a
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x
    - uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '21'
    - name: Install Android workload
      run: dotnet workload install android --source https://api.nuget.org/v3/index.json
    - name: Enable KVM
      if: runner.os == 'Linux'
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
    - name: Build the project
      run: dotnet build AndroidSdk.Tool

    - name: Print SDK information
      run: dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- sdk info

    - name: Install Packages
      run: dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- sdk install -p "emulator" -p "platform-tools" -p "platforms;android-36" -p "${{ matrix.image }}"

    - name: Create and verify AVD
      run: |
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- avd create -f -n "test" -a "${{ matrix.abi }}" -s "${{ matrix.image }}"
        echo "--- Verifying AVD was created ---"
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- avd list
        AVDS=$(dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- avd list --format json 2>/dev/null)
        echo "AVDs JSON: $AVDS"
        if ! echo "$AVDS" | jq -e '.[] | select(.name == "test")' > /dev/null 2>&1; then
          echo "❌ AVD 'test' not found in avd list after create"
          exit 1
        fi
        echo "✅ AVD 'test' created successfully"

    - name: Start and verify AVD
      run: |
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- avd start -p 5554 -n test --no-window --gpu ${{ matrix.gpu }} --no-snapshot --no-audio --no-boot-anim --wait --disable-animations
        echo "--- Verifying emulator is in device list ---"
        DEVICES=$(dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device list --format json 2>/dev/null)
        echo "Devices JSON: $DEVICES"
        COUNT=$(echo "$DEVICES" | jq 'length')
        if [ "$COUNT" -lt 1 ]; then
          echo "❌ No devices found via 'device list --format json' — emulator failed to start"
          exit 1
        fi
        SERIAL=$(echo "$DEVICES" | jq -r '.[0].serial')
        echo "✅ Emulator is running (serial: $SERIAL, count: $COUNT)"

    - name: Create test app
      run: |
        dotnet new android -n TestApp --output TestApp
        sed -i.bak 's/SetContentView(.*);/SetContentView(Resource.Layout.activity_main);\n\t\t\tAndroid.Util.Log.Info("TestApp", "E2E_APP_STARTED_SUCCESSFULLY");/' TestApp/MainActivity.cs
        dotnet build TestApp/TestApp.csproj -f net10.0-android -c Release
        dotnet publish TestApp/TestApp.csproj -f net10.0-android -c Release
        APK=$(find TestApp -name "*.apk" -path "*/publish/*" | head -1)
        if [ -z "$APK" ]; then
          echo "❌ Could not find published APK"
          exit 1
        fi
        echo "✅ APK built: $APK"

    - name: Install and verify test app
      run: |
        APK=$(find TestApp -name "*.apk" -path "*/publish/*" | head -1)
        echo "Installing APK: $APK"
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device install --package "$APK"
        echo "--- Verifying app is installed via device packages ---"
        PKGS=$(dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device packages --format json 2>/dev/null)
        if ! echo "$PKGS" | jq -e '.[] | select(.packageName == "com.companyname.testapp")' > /dev/null 2>&1; then
          echo "❌ com.companyname.testapp not found in device packages"
          echo "$PKGS" | jq '.[].packageName' | head -20
          exit 1
        fi
        echo "✅ App installed and verified via CLI"

    - name: Launch and verify test app
      run: |
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device launch --package com.companyname.testapp
        echo "Waiting for app to run..."
        sleep 5

    - name: Capture and verify logcat
      timeout-minutes: 2
      run: |
        timeout 30 dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- avd logcat --output logcat.txt || true
        if [ ! -f logcat.txt ] || [ ! -s logcat.txt ]; then
          echo "❌ logcat.txt was not created or is empty"
          exit 1
        fi
        echo "--- Logcat (last 30 lines) ---"
        tail -30 logcat.txt
        echo "--- Checking for app log marker ---"
        if ! grep -q "E2E_APP_STARTED_SUCCESSFULLY" logcat.txt; then
          echo "❌ App log marker 'E2E_APP_STARTED_SUCCESSFULLY' not found in logcat"
          exit 1
        fi
        echo "✅ App ran real code successfully"

    - name: Uninstall and verify test app
      if: always()
      run: |
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device uninstall --package com.companyname.testapp || true
        echo "--- Verifying app is uninstalled via device packages ---"
        PKGS=$(dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device packages --format json 2>/dev/null || echo "[]")
        if echo "$PKGS" | jq -e '.[] | select(.packageName == "com.companyname.testapp")' > /dev/null 2>&1; then
          echo "⚠️ com.companyname.testapp still found after uninstall"
        else
          echo "✅ App uninstalled and verified via CLI"
        fi

    - name: Install and verify static test app
      if: runner.os == 'Linux'
      run: |
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device install --package AndroidSdk.Tests/testdata/com.companyname.mauiapp12345-Signed.apk
        echo "--- Verifying static app is installed via device packages ---"
        PKGS=$(dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device packages --format json 2>/dev/null)
        if ! echo "$PKGS" | jq -e '.[] | select(.packageName == "com.companyname.mauiapp12345")' > /dev/null 2>&1; then
          echo "❌ com.companyname.mauiapp12345 not found in device packages"
          exit 1
        fi
        echo "✅ Static test app installed and verified via CLI"

    - name: Uninstall and verify static test app
      if: runner.os == 'Linux'
      run: |
        dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device uninstall --package com.companyname.mauiapp12345
        echo "--- Verifying static app is uninstalled via device packages ---"
        PKGS=$(dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- device packages --format json 2>/dev/null)
        if echo "$PKGS" | jq -e '.[] | select(.packageName == "com.companyname.mauiapp12345")' > /dev/null 2>&1; then
          echo "❌ com.companyname.mauiapp12345 still found in device packages after uninstall"
          exit 1
        fi
        echo "✅ Static test app uninstalled and verified via CLI"

    - name: Delete AVD
      if: always()
      run: dotnet run --no-launch-profile --no-build --framework net10.0 --project AndroidSdk.Tool -- avd delete -n test --force

    - name: Upload logcat
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logcat-${{ matrix.os }}
        path: logcat.txt
        if-no-files-found: ignore
