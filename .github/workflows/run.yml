name: Run Android Emulator

on:
  pull_request:
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  ANDROID_TOOL_PROCESS_RUNNER_LOG_TYPES: stdout|stderr

jobs:
  run:
    name: Run (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            gpu: swiftshader_indirect
            image: system-images;android-34;google_apis;x86_64
            abi: google_apis/x86_64
            cores: 2
            cpu_threshold: 25
            timeout_seconds: 1800
          - os: macos-15-intel
            gpu: guest
            image: system-images;android-34;google_apis;x86_64
            abi: google_apis/x86_64
            cores: 2
            cpu_threshold: 3
            timeout_seconds: 1800
    runs-on: ${{ matrix.os }}
    env:
      AVD_NAME: test
      TEST_APP_PACKAGE: com.companyname.mauiapp12345
      APP_START_MARKER: E2E_APP_STARTED_SUCCESSFULLY
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '21'

    - name: Enable KVM
      if: runner.os == 'Linux'
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Build the project
      run: |
        dotnet build AndroidSdk.Tool/AndroidSdk.Tool.csproj -f net10.0
        echo "TOOL=$PWD/AndroidSdk.Tool/bin/Debug/net10.0/android.dll" >> "$GITHUB_ENV"

    - name: Set AVD environment variables
      run: |
        mkdir -p artifacts
        mkdir -p "$HOME/.android/avd"
        echo "ANDROID_AVD_HOME=$HOME/.android/avd" >> "$GITHUB_ENV"
        echo "ANDROID_EMULATOR_HOME=$HOME/.android" >> "$GITHUB_ENV"

    - name: Print SDK information
      run: dotnet $TOOL sdk info
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/sdk-info.log

    - name: Install Packages
      run: dotnet $TOOL sdk install -p "emulator" -p "platform-tools" -p "platforms;android-34" -p "${{ matrix.image }}"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/sdk-install.log

    - name: Do Create AVD
      run: dotnet $TOOL avd create -f -n "$AVD_NAME" -a "${{ matrix.abi }}" -s "${{ matrix.image }}"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-create-do.log

    - name: Validate Create AVD
      run: |
        ls -la "$ANDROID_AVD_HOME" || echo "AVD HOME dir not found"
        ls -la "$HOME/.config/.android/avd/" || echo "XDG path not found"

        AVDS=$(dotnet $TOOL avd list --format json)
        echo "AVDs JSON: $AVDS"

        if ! echo "$AVDS" | jq -e --arg avd "$AVD_NAME" '.[] | select(.name == $avd)' > /dev/null 2>&1; then
          echo "❌ AVD '$AVD_NAME' not found in avd list after create"
          cat artifacts/avd-create-do.log
          exit 1
        fi
        echo "✅ AVD '$AVD_NAME' created successfully"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-create-validate.log

    - name: Do Start AVD
      run: dotnet $TOOL avd start -p 5554 -n "$AVD_NAME" --no-window --gpu ${{ matrix.gpu }} --no-snapshot --no-audio --no-boot-anim --wait --no-anim --cpu-threshold ${{ matrix.cpu_threshold }} --cores ${{ matrix.cores }} --timeout ${{ matrix.timeout_seconds }}
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-start-do.log

    - name: Validate Start AVD
      run: |
        DEVICES=$(dotnet $TOOL device list --format json)
        echo "Devices JSON: $DEVICES"

        COUNT=$(echo "$DEVICES" | jq 'length')
        if [ "$COUNT" -lt 1 ]; then
          echo "❌ No devices found via 'device list --format json' — emulator failed to start"
          echo "--- Process runner log ---"
          cat artifacts/avd-start-do.log
          exit 1
        fi
        SERIAL=$(echo "$DEVICES" | jq -r '.[0].serial')
        echo "✅ Emulator is running (serial: $SERIAL, count: $COUNT)"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-start-validate.log

    - name: Do Install test app
      run: dotnet $TOOL device install --package "AndroidSdk.Tests/testdata/com.companyname.mauiapp12345-Signed.apk"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-install-do.log

    - name: Validate Install test app
      run: |
        FOUND=0
        for i in $(seq 1 12); do
          PKGS=$(dotnet $TOOL device packages --format json)
          if echo "$PKGS" | jq -e --arg pkg "$TEST_APP_PACKAGE" '.[] | select(.packageName == $pkg)' > /dev/null 2>&1; then
            echo "✅ App installed and verified via CLI (attempt $i)"
            FOUND=1
            break
          fi
          echo "Attempt $i/12 - package not visible yet, waiting 5s..."
          sleep 5
        done

        if [ "$FOUND" -ne 1 ]; then
          echo "❌ $TEST_APP_PACKAGE not found in device packages after retries"
          echo "$PKGS" | jq '.[].packageName' | head -20
          echo "--- Process runner log ---"
          cat artifacts/device-install-do.log
          exit 1
        fi
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-install-validate.log

    - name: Do Launch test app
      run: dotnet $TOOL device launch --package "$TEST_APP_PACKAGE"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-launch-do.log

    - name: Validate Launch test app
      timeout-minutes: 10
      run: |
        FOUND_APP=0
        FOUND_DISPLAYED=0
        for i in $(seq 1 30); do
          dotnet $TOOL device logcat --output artifacts/device-logcat.txt
          if [ "$FOUND_APP" -eq 0 ] && grep -q "$APP_START_MARKER" artifacts/device-logcat.txt; then
            echo "✅ App marker '$APP_START_MARKER' found on attempt $i"
            FOUND_APP=1
          fi
          if [ "$FOUND_DISPLAYED" -eq 0 ] && grep -q "Displayed $TEST_APP_PACKAGE" artifacts/device-logcat.txt; then
            echo "✅ System 'Displayed' marker found on attempt $i"
            FOUND_DISPLAYED=1
          fi
          if [ "$FOUND_APP" -eq 1 ] && [ "$FOUND_DISPLAYED" -eq 1 ]; then
            break
          fi
          echo "Attempt $i/30 - waiting 5s... (app_marker=$FOUND_APP, displayed=$FOUND_DISPLAYED)"
          sleep 5
        done
        if [ "$FOUND_APP" -ne 1 ] || [ "$FOUND_DISPLAYED" -ne 1 ]; then
          echo "❌ Not all markers found after 30 attempts (app_marker=$FOUND_APP, displayed=$FOUND_DISPLAYED)"
          cat artifacts/device-logcat.txt
          exit 1
        fi
        echo "✅ Launch validated — both markers found"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-launch-validate.log

    - name: Do Uninstall test app
      if: always()
      run: dotnet $TOOL device uninstall --package "$TEST_APP_PACKAGE"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-uninstall-do.log

    - name: Validate Uninstall test app
      if: always()
      run: |
        PKGS=$(dotnet $TOOL device packages --format json)
        echo "Packages JSON: $PKGS"

        if echo "$PKGS" | jq -e --arg pkg "$TEST_APP_PACKAGE" '.[] | select(.packageName == $pkg)' > /dev/null 2>&1; then
          echo "❌ $TEST_APP_PACKAGE still found after uninstall"
          exit 1
        else
          echo "✅ App uninstalled and verified via CLI"
        fi
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-uninstall-validate.log

    - name: Delete AVD
      if: always()
      run: dotnet $TOOL avd delete -n "$AVD_NAME" --force
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-delete.log

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ matrix.os }}
        path: artifacts/
        if-no-files-found: ignore
