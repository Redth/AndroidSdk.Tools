name: Run Android Emulator

on:
  pull_request:
  push:
    branches: [ main ]

concurrency:
  group: run-${{ github.ref }}
  cancel-in-progress: true

env:
  ANDROID_TOOL_PROCESS_RUNNER_LOG_TYPES: stdout|stderr

jobs:
  run:
    name: Run
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 9.0.x
    - uses: actions/setup-java@v4
      with:
        distribution: 'microsoft'
        java-version: '21'
    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
    - name: Build the project
      run: dotnet build AndroidSdk.Tool
    - name: Set AVD environment variables
      run: |
        mkdir -p artifacts
        mkdir -p "$HOME/.android/avd"
        echo "ANDROID_AVD_HOME=$HOME/.android/avd" >> "$GITHUB_ENV"
        echo "ANDROID_EMULATOR_HOME=$HOME/.android" >> "$GITHUB_ENV"
    - name: Print SDK information
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- sdk info
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/sdk-info.log
    - name: Install Packages
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- sdk install -p "emulator" -p "platform-tools" -p "platforms;android-34" -p "system-images;android-34;google_apis;x86_64"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/sdk-install.log
    - name: Do Create AVD
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- avd create -f -n "test" -a "google_apis/x86_64" -s "system-images;android-34;google_apis;x86_64"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-create-do.log
    - name: Validate Create AVD
      run: |
        AVDS=$(dotnet run --no-launch-profile --framework net9.0 --project AndroidSdk.Tool -- avd list --format json | tail -n 1)
        echo "AVDs JSON: $AVDS"
        if ! echo "$AVDS" | jq -e '.[] | select(.name == "test")' > /dev/null 2>&1; then
          echo "❌ AVD 'test' not found in avd list after create"
          cat artifacts/avd-create-do.log
          exit 1
        fi
        echo "✅ AVD 'test' created successfully"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-create-validate.log
    - name: Do Start AVD
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- avd start -p 5554 -n test --no-window --gpu swiftshader_indirect --no-snapshot --no-audio --no-boot-anim --wait --disable-animations
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-start-do.log
    - name: Validate Start AVD
      run: |
        DEVICES=$(dotnet run --no-launch-profile --framework net9.0 --project AndroidSdk.Tool -- device list --format json | tail -n 1)
        echo "Devices JSON: $DEVICES"
        COUNT=$(echo "$DEVICES" | jq 'length')
        if [ "$COUNT" -lt 1 ]; then
          echo "❌ No devices found via 'device list --format json' — emulator failed to start"
          cat artifacts/avd-start-do.log
          exit 1
        fi
        dotnet run --framework net9.0 --project AndroidSdk.Tool -- device info
        echo "✅ Emulator is running and device commands are healthy"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-start-validate.log
    - name: Do Install test app
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- device install --package AndroidSdk.Tests/testdata/com.companyname.mauiapp12345-Signed.apk
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-install-do.log
    - name: Validate Install test app
      run: |
        PACKAGE_NAME="com.companyname.mauiapp12345"
        PACKAGES=$(dotnet run --no-launch-profile --framework net9.0 --project AndroidSdk.Tool -- device packages --format json | tail -n 1)
        echo "$PACKAGES" > artifacts/packages-after-install.json
        if ! echo "$PACKAGES" | jq -e --arg pkg "$PACKAGE_NAME" '.[] | select(.packageName == $pkg)' > /dev/null 2>&1; then
          echo "❌ Package '$PACKAGE_NAME' missing after install"
          cat artifacts/device-install-do.log
          exit 1
        fi
        echo "✅ Package '$PACKAGE_NAME' installed successfully"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-install-validate.log
    - name: Do Launch test app
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- device launch --package com.companyname.mauiapp12345
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-launch-do.log
    - name: Validate Launch test app
      run: |
        if ! grep -qi "Events injected" artifacts/device-launch-do.log; then
          echo "❌ Launch validation failed: expected strict 'Events injected' marker"
          cat artifacts/device-launch-do.log
          exit 1
        fi
        echo "✅ Launch validation passed with strict 'Events injected' marker"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-launch-validate.log
    - name: Do Capture logcat
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- device logcat --output artifacts/device-logcat.txt
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-logcat-do.log
    - name: Validate launch marker in logcat
      timeout-minutes: 10
      run: |
        FOUND=0
        for i in $(seq 1 30); do
          dotnet run --framework net9.0 --project AndroidSdk.Tool -- device logcat --output artifacts/device-logcat.txt
          if grep -q "E2E_APP_STARTED_SUCCESSFULLY" artifacts/device-logcat.txt; then
            echo "✅ Marker found on attempt $i"
            FOUND=1
            break
          fi
          echo "Attempt $i/30 - marker not found yet, waiting 5s..."
          sleep 5
        done
        if [ "$FOUND" -ne 1 ]; then
          echo "❌ Marker not found in logcat after 30 attempts"
          cat artifacts/device-logcat.txt
          exit 1
        fi
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-logcat-validate.log
    - name: Do Uninstall test app
      if: always()
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- device uninstall --package com.companyname.mauiapp12345
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-uninstall-do.log
    - name: Validate Uninstall test app
      if: always()
      run: |
        PACKAGE_NAME="com.companyname.mauiapp12345"
        PACKAGES=$(dotnet run --no-launch-profile --framework net9.0 --project AndroidSdk.Tool -- device packages --format json | tail -n 1)
        echo "$PACKAGES" > artifacts/packages-after-uninstall.json
        if echo "$PACKAGES" | jq -e --arg pkg "$PACKAGE_NAME" '.[] | select(.packageName == $pkg)' > /dev/null 2>&1; then
          echo "❌ Package '$PACKAGE_NAME' still present after uninstall"
          cat artifacts/device-uninstall-do.log
          exit 1
        fi
        echo "✅ Package '$PACKAGE_NAME' uninstalled successfully"
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/device-uninstall-validate.log
    - name: Delete AVD
      if: always()
      run: dotnet run --framework net9.0 --project AndroidSdk.Tool -- avd delete -n test --force
      env:
        ANDROID_TOOL_PROCESS_RUNNER_LOG_PATH: artifacts/avd-delete.log
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-ubuntu-latest
        path: artifacts/
        if-no-files-found: ignore
